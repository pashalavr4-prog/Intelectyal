<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Война чанков — карта с ботами</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html,body,#map { height: 100%; margin: 0; padding: 0; }
#map { position: absolute; left: 0; right: 320px; top: 0; bottom: 0; }
#sidebar { position: absolute; right: 0; top: 0; width: 320px; bottom: 0; background: #1e293b; color: #e6eef8; padding: 12px; box-sizing: border-box; font-family: Arial, sans-serif; overflow-y: auto; }
h2 { margin: 6px 0 12px; font-size: 18px; }
.info-row { margin: 8px 0; }
button { background: #2563eb; color: white; border: none; padding: 8px 10px; border-radius: 6px; cursor: pointer; }
.btn-ghost { background: #334155; }
.chunk-info { margin-top:8px; background:#081226; padding:8px; border-radius:6px; }
.owner-player { color: #7ee787; }
.owner-bot { color: #ffb86b; }
.owner-none { color: #9aa7b2; }
.small { font-size: 13px; color:#a8b3c7; }
.structure { font-size:12px; padding:4px 6px; background:#1f2937; border-radius:4px; display:inline-block; margin-right:6px; }
.money { font-weight:700; font-size:18px; }
.log { font-family: monospace; font-size:12px; background:#020617; padding:6px; border-radius:6px; color:#9fb6d6; max-height:220px; overflow:auto; }

#taxPanel {
  position: absolute;
  left: 10px;
  bottom: 10px;
  background: #111827;
  color: #f3f4f6;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 14px;
  font-family: Arial, sans-serif;
  z-index: 1000;
  pointer-events: auto;
}

#newsPopup {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #1e293b;
  color: #f3f4f6;
  padding: 12px 16px;
  border-radius: 8px;
  font-family: Arial, sans-serif;
  font-size: 14px;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
  z-index: 1100;
  display: none;
}
#newsPopup button { margin-left:12px; background:#ef4444; }
</style>
</head>
<body>
<div id="map"></div>
<div id="sidebar">
<h2>Война чанков — прототип</h2>
<div class="info-row">Деньги: <span id="money" class="money">—</span></div>
<div class="info-row small">Чанк = квадрат <strong id="chunkSizeDisplay"></strong>×<strong id="chunkSizeDisplay2"></strong> км</div>
<div class="info-row">
  <button id="spawnBotsBtn">Распределить ботов заново (сброс)</button>
  <button id="resetBtn" class="btn-ghost">Сброс прогресса</button>
</div>
<hr style="border-color:#16304a">
<div id="selectedTitle" class="small">Кликните по карте, чтобы выбрать чанк</div>
<div id="selectedInfo" class="chunk-info" style="display:none"></div>
<hr style="border-color:#16304a">
<div class="info-row"><strong>Мои чанки:</strong> <span id="myChunksCount">0</span></div>
<div class="info-row"><strong>Лог:</strong></div>
<div id="log" class="log"></div>
<div id="leaderboardContainer"></div>
<div style="margin-top:12px" class="small">
Прототип использует Leaflet + localStorage. Можно изменять параметры прямо в коде.
</div>
</div>

<div id="taxPanel">
  Налог/Доход: <span id="taxAmount">0</span><br>
  Через: <span id="taxTimer">30</span> сек
</div>

<div id="newsPopup">
  <span id="newsText"></span>
  <button id="closeNewsBtn">Закрыть</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===================== Параметры игры ===================== */
const CHUNK_SIZE_KM = 25; // размер одного чанка в км
const INITIAL_MONEY = 5000;
const BOT_COUNT = 120;
const BOT_MOVE_INTERVAL = 8000;
const BOT_ATTACK_INTERVAL = 12000;
const PLAYER_ATTACK_COST = 200;
const CHUNK_BASE_COST = 500;
const STRUCTURE_COST = 300;
const TAX_INTERVAL = 30;
const TAX_PER_CHUNK = 550;
const TAX_PER_HOUSE = 50;
const HOUSE_INCOME = 150;
const KM_TO_M = 1000;

let taxTimer = TAX_INTERVAL;

/* ===================== Инициализация ===================== */
const map = L.map('map', { worldCopyJump:true }).setView([20,0], 2);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

document.getElementById('chunkSizeDisplay').textContent = CHUNK_SIZE_KM;
document.getElementById('chunkSizeDisplay2').textContent = CHUNK_SIZE_KM;

const state = {
  money: INITIAL_MONEY,
  chunks: {},
  bots: {},
  markers: { chunkRects: {}, botMarkers: {}, structures: {} },
  selectedChunk: null,
};

/* ---------- localStorage ---------- */
function saveState(){ localStorage.setItem('war_chunks_v3', JSON.stringify({money:state.money,chunks:state.chunks,bots:state.bots})); }
function loadState(){
  const raw = localStorage.getItem('war_chunks_v3');
  if(!raw) return false;
  try{ const p=JSON.parse(raw); state.money=p.money??INITIAL_MONEY; state.chunks=p.chunks??{}; state.bots=p.bots??{}; return true;} 
  catch(e){console.error(e); return false;}
}
function resetAll(){ localStorage.removeItem('war_chunks_v3'); location.reload(); }

/* ---------- гео утилиты ---------- */
function latLngToMeters(lat,lng){const R=6378137; return [R*lng*Math.PI/180, R*Math.log(Math.tan(Math.PI/4+lat*Math.PI/360))];}
function metersToLatLng(x,y){const R=6378137; return [(2*Math.atan(Math.exp(y/R))-Math.PI/2)*180/Math.PI, x*180/(Math.PI*R)];}
function chunkKeyFromLatLng(lat,lng){const [xMeters,yMeters]=latLngToMeters(lat,lng);return `${Math.floor(xMeters/(CHUNK_SIZE_KM*KM_TO_M))}_${Math.floor(yMeters/(CHUNK_SIZE_KM*KM_TO_M))}`;}
const chunkBoundsCache={};
function chunkBoundsFromKey(key){
  if(chunkBoundsCache[key]) return chunkBoundsCache[key];
  const [xIndex,yIndex]=key.split('_').map(Number);
  const x1=xIndex*CHUNK_SIZE_KM*KM_TO_M, y1=yIndex*CHUNK_SIZE_KM*KM_TO_M;
  const x2=x1+CHUNK_SIZE_KM*KM_TO_M, y2=y1+CHUNK_SIZE_KM*KM_TO_M;
  return chunkBoundsCache[key]=[metersToLatLng(x1,y1), metersToLatLng(x2,y2)];
}
function randomPointInChunk(key){
  const bounds=chunkBoundsFromKey(key);
  return [bounds[0][0]+Math.random()*(bounds[1][0]-bounds[0][0]), bounds[0][1]+Math.random()*(bounds[1][1]-bounds[0][1])];
}

/* ---------- logging ---------- */
function log(msg){const el=document.getElementById('log'); el.innerHTML=`[${new Date().toLocaleTimeString()}] ${msg}<br>`+el.innerHTML;}

/* ---------- chunks ---------- */
function renderChunk(key, forceVisible=false){
  if(state.markers.chunkRects[key]) return;
  const bounds = chunkBoundsFromKey(key);
  const rect = L.rectangle(bounds,{
    color:'#00000000', weight:0, fill:true, fillOpacity: 0, interactive:true // <-- невидимо
  }).addTo(map);
  rect.on('click',()=>selectChunk(key));
  state.markers.chunkRects[key] = rect;
}

/* ---------- selection ---------- */
function selectChunk(key){
  state.selectedChunk=key; renderChunk(key,true);
  const info=document.getElementById('selectedInfo'); info.style.display='block';
  const chunk=state.chunks[key]||{owner:null,structures:[],powerModifier:0};
  const owner=chunk.owner;
  const ownerText=owner==='player'?'<span class="owner-player">Игрок</span>':owner?`<span class="owner-bot">Бот ${owner}</span>`:'<span class="owner-none">Свободен</span>';
  const bounds=chunkBoundsFromKey(key);
  const centerLat=(bounds[0][0]+bounds[1][0])/2, centerLng=(bounds[0][1]+bounds[1][1])/2;
  info.innerHTML=`<div class="small">Чанк: <strong>${key}</strong></div>
    <div class="small">Центр: ${centerLat.toFixed(2)}, ${centerLng.toFixed(2)}</div>
    <div style="margin-top:8px">Владелец: ${ownerText}</div>
    <div style="margin-top:6px">Структуры: ${chunk.structures.length||0} ${chunk.structures.map(s=>`<span class="structure">${s}</span>`).join('')}</div>
    <div style="margin-top:8px">
      ${owner===null?`<button id="buyBtn">Купить (${CHUNK_BASE_COST})</button>`:''}
      ${owner&&owner!=='player'?`<button id="attackBtn">Атаковать (${PLAYER_ATTACK_COST})</button>`:''}
      ${owner==='player'?`<button id="buildBtn">Построить (${STRUCTURE_COST})</button>`:''}
    </div>
  `;

  if(owner===null) document.getElementById('buyBtn').onclick=()=>{ 
    if(state.money<CHUNK_BASE_COST){alert('Недостаточно денег'); return;}
    state.money-=CHUNK_BASE_COST;
    state.chunks[key]={owner:'player',structures:[],powerModifier:0};
    saveState(); refreshUI();
  };

  if(owner&&owner!=='player') document.getElementById('attackBtn').onclick=()=>{ 
    if(state.money<PLAYER_ATTACK_COST){alert('Недостаточно денег'); return;}
    state.money-=PLAYER_ATTACK_COST;
    const success=Math.random()>0.5; // упрощение
    if(success){state.chunks[key].owner='player'; log(`Игрок победил бота ${owner} и захватил чанк ${key}`);}
    saveState(); refreshUI();
  };

  if(owner==='player') document.getElementById('buildBtn').onclick=()=>{ 
    if(state.money<STRUCTURE_COST){alert('Недостаточно денег'); return;}
    state.money-=STRUCTURE_COST;
    state.chunks[key].structures.push('House Sticker');
    const pos=randomPointInChunk(key);
    const marker=L.marker(pos).addTo(map).bindPopup('Стикер дома');
    if(!state.markers.structures[key]) state.markers.structures[key]=[];
    state.markers.structures[key].push(marker);
    log(`Игрок построил House Sticker в чанке ${key}`);
    saveState(); refreshUI();
  };
}

/* ---------- bots ---------- */
function spawnBotsRandomly(count){
  for(const id in state.markers.botMarkers) map.removeLayer(state.markers.botMarkers[id]||0);
  state.bots={};
  for(let i=0;i<count;i++){
    const id=`B${i+1}`, lat=Math.random()*180-90, lng=Math.random()*360-180;
    const key=chunkKeyFromLatLng(lat,lng);
    const bot={id,name:`Bot-${i+1}`,color:'#ffb86b',chunkKey:key,power:40+Math.floor(Math.random()*90)};
    state.bots[id]=bot;
    state.chunks[key]=state.chunks[key]||{owner:null,structures:[],powerModifier:0};
    if(!state.chunks[key].owner) state.chunks[key].owner=id;
  }
  saveState(); renderAllBots(); log(`Распределено ${count} ботов по миру`);
}

function renderAllBots(){
  for(const id in state.markers.botMarkers) map.removeLayer(state.markers.botMarkers[id]||0);
  state.markers.botMarkers={};
  for(const id in state.bots) placeBotMarker(id);
}

function placeBotMarker(botId){
  const bot=state.bots[botId]; 
  const pos=randomPointInChunk(bot.chunkKey);
  state.markers.botMarkers[botId]=L.circleMarker(pos,{radius:8,color:bot.color,fillColor:bot.color,fillOpacity:0.9})
  .addTo(map)
  .bindPopup(`<b>${bot.name}</b><br>Power: ${bot.power}<br>Chunk: ${bot.chunkKey}`);
}

function botMoveStep(botId){
  const bot=state.bots[botId]; if(!bot) return;
  const adj=[`${bot.chunkKey.split('_')[0]*1+1}_${bot.chunkKey.split('_')[1]}`,`${bot.chunkKey.split('_')[0]*1-1}_${bot.chunkKey.split('_')[1]}`,`${bot.chunkKey.split('_')[0]}_${bot.chunkKey.split('_')[1]*1+1}`,`${bot.chunkKey.split('_')[0]}_${bot.chunkKey.split('_')[1]*1-1}`];
  if(!adj.length||Math.random()<0.35) return; 
  const next=adj[Math.floor(Math.random()*adj.length)];
  bot.chunkKey=next; 
  state.chunks[next]=state.chunks[next]||{owner:null,structures:[],powerModifier:0}; 
  if(!state.chunks[next].owner && Math.random()<0.7){state.chunks[next].owner=botId;}
  saveState(); placeBotMarker(botId);
}

function botTryAttack(botId){
  const bot=state.bots[botId]; if(!bot) return;
  const targets=[`${bot.chunkKey.split('_')[0]*1+1}_${bot.chunkKey.split('_')[1]}`,`${bot.chunkKey.split('_')[0]*1-1}_${bot.chunkKey.split('_')[1]}`,`${bot.chunkKey.split('_')[0]}_${bot.chunkKey.split('_')[1]*1+1}`,`${bot.chunkKey.split('_')[0]}_${bot.chunkKey.split('_')[1]*1-1}`]
    .filter(k=>state.chunks[k]?.owner==='player');
  if(!targets.length) return; 
  const target=targets[Math.floor(Math.random()*targets.length)];
  if(Math.random()>0.5){state.chunks[target].owner=botId;}
  saveState();
}

/* ---------- taxes & income ---------- */
function processTaxes(){
  taxTimer--; 
  if(taxTimer<=0){ 
    taxTimer=TAX_INTERVAL;
    let tax=0, income=0;
    for(const k in state.chunks){
      if(state.chunks[k].owner==='player'){
        const houses=state.chunks[k].structures.length;
        tax+=TAX_PER_CHUNK+houses*TAX_PER_HOUSE; 
        income+=houses*HOUSE_INCOME;
      }
    }
    state.money+=income-tax;
    document.getElementById('taxAmount').textContent = `${income-tax} (Доход:${income} Налог:${tax})`;
    saveState(); refreshUI();
  }
  document.getElementById('taxTimer').textContent = taxTimer;
}

/* ---------- news popup ---------- */
const newsSamples=[
  'В стране бота произошёл пожар!', 'Банк объявил о дефолте', 'Протесты в столице', 'Войска перемещены на север', 
  'Налоговая инспекция проверяет игроков', 'Бот потерял контроль над чанком', 'Ресурсы выросли на 15%', 'Пандемия охватила регион',
  'Появился новый лидер бота', 'Стихийное бедствие уничтожило дома', 'Игроки собрались на митинг', 'Дипломатический скандал между ботами',
  'Власть сменилась в стране бота', 'Технологии ускорили производство', 'Чанк игрока подвергся атаке', 'В стране бота обнаружен контрабандист',
  'Бот усилил армию', 'Игроки строят новые дома', 'Чанк повреждён стихией', 'Бот потерял доход'
];
function showRandomNews(){ const idx=Math.floor(Math.random()*newsSamples.length); const el=document.getElementById('newsText'); el.textContent=newsSamples[idx]; document.getElementById('newsPopup').style.display='block'; }
document.getElementById('closeNewsBtn').onclick=()=>{document.getElementById('newsPopup').style.display='none';};

/* ---------- refresh UI ---------- */
function refreshUI(){
  document.getElementById('money').textContent=state.money;
  const myChunks=Object.values(state.chunks).filter(c=>c.owner==='player').length;
  document.getElementById('myChunksCount').textContent=myChunks;
  if(state.selectedChunk) selectChunk(state.selectedChunk);
}

/* ---------- loops ---------- */
loadState(); refreshUI();
spawnBotsRandomly(BOT_COUNT);

setInterval(()=>{for(const id in state.bots) botMoveStep(id);},BOT_MOVE_INTERVAL);
setInterval(()=>{for(const id in state.bots) botTryAttack(id);},BOT_ATTACK_INTERVAL);
setInterval(processTaxes,1000);
setInterval(showRandomNews,12000);

/* ---------- buttons ---------- */
document.getElementById('spawnBotsBtn').onclick=()=>spawnBotsRandomly(BOT_COUNT);
document.getElementById('resetBtn').onclick=()=>{ if(confirm('Сбросить всё?')) resetAll(); };

</script>
</body>
</html>
