<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–∞—Ä—Ç–∞ —Å —Ä–∞–±–æ—á–∏–º–∏, –±–æ—Ç–∞–º–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html, body { margin:0; padding:0; height:100%; background:#111; font-family:sans-serif; }
#map { width:100%; height:calc(100% - 70px); }
#ui { height:70px; display:flex; align-items:center; justify-content:space-around; padding:5px 10px; background:#222; color:#fff; box-shadow:0 -2px 5px rgba(0,0,0,0.5);}
button { padding:6px 12px; cursor:pointer; border:none; border-radius:5px; background:#00aaff; color:#fff; font-weight:bold; transition:0.2s; font-size:14px;}
button:hover { background:#0088cc; }
.house, .shop, .factory { font-size:18px; }
.info { display:flex; flex-direction:column; align-items:center; font-size:14px; }
.status { position:absolute; bottom:75px; left:50%; transform:translateX(-50%); background:#333; padding:5px 10px; border-radius:5px; color:#fff; font-size:14px; }
.botLabel { font-size:12px; color:#fff; padding:2px 6px; background:rgba(0,0,0,0.5); border-radius:4px; }
</style>
</head>
<body>

<div id="map"></div>
<div id="ui">
  <div class="info">üí∞ <span id="coins">5000</span></div>
  <div class="info">üë• <span id="population">0</span></div>
  <button id="buildHouseBtn">–î–æ–º (100)</button>
  <button id="buildShopBtn">–ú–∞–≥–∞–∑–∏–Ω (350)</button>
  <button id="buildFactoryBtn">–§–∞–±—Ä–∏–∫–∞ (850)</button>
  <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button id="resetBtn">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å</button>
</div>
<div class="status" id="workStatus">üíº –†–∞–±–æ—á–∏—Ö –Ω–µ—Ç / –í—Å–µ –∑–¥–∞–Ω–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ---- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ----
const COST_PER_100M=50, ADD_VERTEX_THRESHOLD=100;
const HOUSE_COST=100, HOUSE_INCOME=50;
const SHOP_COST=350, SHOP_INCOME=100, SHOP_WORKERS=3;
const FACTORY_COST=850, FACTORY_INCOME=250, FACTORY_WORKERS=25;

let coins=5000, population=0;
let polygon=null, handles=[], houses=[], shops=[], factories=[];
let buildMode=null;

// ---- –ö–∞—Ä—Ç–∞ ----
const map=L.map('map').setView([20,0],13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{subdomains:'abcd',maxZoom:19,opacity:0.9}).addTo(map);

const coinDisplay=document.getElementById('coins');
const popDisplay=document.getElementById('population');
const statusDisplay=document.getElementById('workStatus');
const updateCoins=amt=>{ coins+=amt; coinDisplay.textContent=coins; };
const updatePopulation=amt=>{ population+=amt; popDisplay.textContent=population; updateStatus(); };

// ---- –ü–æ–º–æ—â–Ω–∏–∫–∏ ----
const distance=(a,b)=>map.distance(a,b);
function offsetLatLng(latlng, dx_m, dy_m){
  const R=6378137;
  const dLat=dy_m/R*(180/Math.PI);
  const dLng=dx_m/(R*Math.cos(latlng.lat*Math.PI/180))*(180/Math.PI);
  return [latlng.lat+dLat, latlng.lng+dLng];
}

// ---- Convex Hull (–¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π) ----
function convexHull(points){
  if(points.length<=2) return points.slice();
  points = points.slice().map(p=>[p[0],p[1]]);
  points.sort((a,b)=>a[0]-b[0] || a[1]-b[1]);
  const cross=(o,a,b)=>(a[0]-o[0])*(b[1]-o[1])-(a[1]-o[1])*(b[0]-o[0]);
  const lower=[], upper=[];
  for(let p of points){
    while(lower.length>=2 && cross(lower[lower.length-2],lower[lower.length-1],p)<=0) lower.pop();
    lower.push(p);
  }
  for(let i=points.length-1;i>=0;i--){
    let p=points[i];
    while(upper.length>=2 && cross(upper[upper.length-2],upper[upper.length-1],p)<=0) upper.pop();
    upper.push(p);
  }
  upper.pop(); lower.pop();
  return lower.concat(upper);
}

// ---- –ë–æ—Ç—ã ----
let botColors=['purple','orange','green','yellow','cyan','pink','lime','red','blue','magenta','brown','teal','olive','navy','maroon','aqua','silver','gold','violet','indigo','coral','salmon','plum','tan','khaki'];
let bots=[];
const BOT_COUNT=25;

// —Å–æ–∑–¥–∞—ë—Ç –ø—É—Å—Ç—ã—Ö –±–æ—Ç–æ–≤ (–±—É–¥—É—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –Ω–∏–∂–µ –∏–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ)
for(let i=0;i<BOT_COUNT;i++){
  bots.push({ name:'–ë–æ—Ç'+(i+1), color:botColors[i%botColors.length], polygon:null,
              houses:[], shops:[], factories:[], population:50, coins:5000, markers: {houses:[],shops:[],factories:[]} });
}

// ---- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–æ–≤ (–µ—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è) ----
function initBotsRandomly(){
  bots.forEach((bot,idx)=>{
    // –∏—â–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ç–æ—á–∫—É (–ø—Ä–æ—Å—Ç–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–∫–æ–ª–æ —Ü–µ–Ω—Ç—Ä–∞)
    let lat,lng,tries=0;
    do{
      lat = 20 + (Math.random()-0.5)*0.6; // —á—É—Ç—å —Ä–∞–Ω–¥–æ–º–∞ –≤–æ–∫—Ä—É–≥
      lng = 0 + (Math.random()-0.5)*0.6;
      tries++;
      if(tries>200) break;
    }while(lat<0);
    const sw=offsetLatLng({lat,lng},0,0);
    const se=offsetLatLng({lat,lng},400,0);
    const ne=offsetLatLng({lat,lng},400,400);
    const nw=offsetLatLng({lat,lng},0,400);
    const latlngs = [ {lat:sw[0], lng:sw[1]}, {lat:se[0], lng:se[1]}, {lat:ne[0], lng:ne[1]}, {lat:nw[0], lng:nw[1]} ];
    bot.polygon = L.polygon(latlngs,{color:bot.color, weight:2, opacity:0.9}).addTo(map);
    // label for bot
    const center = bot.polygon.getBounds().getCenter();
    bot.label = L.marker(center, { interactive:false, icon:L.divIcon({className:'botLabel', html:bot.name, iconSize:[60,20]}) }).addTo(map);
  });
}

// ---- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Ç–æ—á–µ–∫ —Å –ø–æ–ª–∏–≥–æ–Ω–∞–º–∏ –¥—Ä—É–≥–∏—Ö –±–æ—Ç–æ–≤ ----
function intersectsOtherBots(latlng,botIndex){
  for(let i=0;i<bots.length;i++){
    if(i===botIndex) continue;
    if(!bots[i].polygon) continue;
    if(bots[i].polygon.getBounds().contains(latlng)) return true;
  }
  // —Ç–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å –∏–≥—Ä–æ–∫–æ–º (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –º–æ–∂–Ω–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å)
  if(polygon && polygon.getBounds().contains(latlng)) return true;
  return false;
}

// ---- –ü–æ–ª–∏–≥–æ–Ω –∏–≥—Ä–æ–∫–∞ –∏ —Ä—É—á–∫–∏ ----
function initHandles(){
  handles.forEach(h=>map.removeLayer(h)); handles=[];
  if(!polygon) return;
  const latlngs=polygon.getLatLngs()[0];
  latlngs.forEach((pt,i)=>{
    const handle=L.circleMarker(pt,{radius:6,color:'red',weight:2,fillColor:'yellow',fillOpacity:1}).addTo(map);
    handle.on('mousedown',ev=>{
      map.dragging.disable();
      const start=ev.latlng; map.on('mousemove',onDrag); map.once('mouseup',onUp);
      function onDrag(e){ handle.setLatLng(e.latlng); latlngs[i]=e.latlng; polygon.setLatLngs([latlngs]); }
      function onUp(e){
        map.off('mousemove',onDrag);
        const dist=distance(start,e.latlng);
        const cost=Math.floor(dist/100)*COST_PER_100M;
        if(coins>=cost){ updateCoins(-cost);
          const next=(i+1)%latlngs.length;
          if(distance(latlngs[i],latlngs[next])>=ADD_VERTEX_THRESHOLD){
            const midLat=(latlngs[i].lat+latlngs[next].lat)/2;
            const midLng=(latlngs[i].lng+latlngs[next].lng)/2;
            latlngs.splice(next,0,[midLat,midLng]); polygon.setLatLngs([latlngs]);
          }
          initHandles();
        } else { latlngs[i]=start; polygon.setLatLngs([latlngs]); handle.setLatLng(start); alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç!"); }
        map.dragging.enable();
      }
    });
    handles.push(handle);
  });
}

// ---- –°–æ–∑–¥–∞–Ω–∏–µ –∫–≤–∞–¥—Ä–∞—Ç–∞ 1–∫–º√ó1–∫–º ----
map.on('click',e=>{
  if(!polygon && coins>=50){
    const sw=offsetLatLng(e.latlng,0,0);
    const se=offsetLatLng(e.latlng,1000,0);
    const ne=offsetLatLng(e.latlng,1000,1000);
    const nw=offsetLatLng(e.latlng,0,1000);
    polygon=L.polygon([sw,se,ne,nw],{color:'blue'}).addTo(map);
    updateCoins(-50); initHandles();
    return;
  }
  if(!polygon || !buildMode) return;
  if(!polygon.getBounds().contains(e.latlng)){ alert("–ú–æ–∂–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏!"); return; }

  if(buildMode==='house' && coins>=HOUSE_COST){
    const pop=Math.floor(Math.random()*4)+3;
    updatePopulation(pop);
    updateCoins(-HOUSE_COST);
    houses.push(L.marker(e.latlng,{icon:L.divIcon({className:'house',html:'üè†',iconSize:[24,24]})}).addTo(map));
  }
  if(buildMode==='shop' && coins>=SHOP_COST){
    updateCoins(-SHOP_COST);
    shops.push({marker:L.marker(e.latlng,{icon:L.divIcon({className:'shop',html:'üè¨',iconSize:[24,24]})}).addTo(map), workers:SHOP_WORKERS});
  }
  if(buildMode==='factory' && coins>=FACTORY_COST){
    updateCoins(-FACTORY_COST);
    factories.push({marker:L.marker(e.latlng,{icon:L.divIcon({className:'factory',html:'üè≠',iconSize:[24,24]})}).addTo(map), workers:FACTORY_WORKERS});
  }

  buildMode=null; document.getElementById('buildHouseBtn').textContent="–î–æ–º (100)";
  updateStatus();
});

// ---- –ö–Ω–æ–ø–∫–∏ ----
document.getElementById('buildHouseBtn').onclick=()=>{ buildMode='house'; document.getElementById('buildHouseBtn').textContent="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –¥–ª—è –¥–æ–º–∞"; }
document.getElementById('buildShopBtn').onclick=()=>{ buildMode='shop'; }
document.getElementById('buildFactoryBtn').onclick=()=>{ buildMode='factory'; }

// ---- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–≤–∫–ª—é—á–∞—è –±–æ—Ç–æ–≤) ----
document.getElementById('saveBtn').onclick=()=>{
  const data={coins,population,
    houses: houses.map(h=>h.getLatLng()),
    shops: shops.map(s=>({latlng:s.marker.getLatLng(), workers:s.workers})),
    factories: factories.map(f=>({latlng:f.marker.getLatLng(), workers:f.workers})),
    polygon: polygon ? polygon.getLatLngs()[0] : null,
    bots: bots.map(b=>{
      return {
        name: b.name,
        color: b.color,
        coins: b.coins,
        population: b.population,
        polygon: b.polygon ? b.polygon.getLatLngs()[0] : null,
        houses: b.houses.map(m=>m.getLatLng ? m.getLatLng() : m),
        shops: b.shops.map(s=>({latlng: s.marker.getLatLng ? s.marker.getLatLng() : s.latlng, workers: s.workers})),
        factories: b.factories.map(f=>({latlng: f.marker.getLatLng ? f.marker.getLatLng() : f.latlng, workers: f.workers}))
      };
    })
  };
  localStorage.setItem('gameSave', JSON.stringify(data));
  alert("–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
};

// ---- –°–±—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ----
document.getElementById('resetBtn').onclick=()=>{
  if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ? –í—Å—ë –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω–æ!")){
    localStorage.removeItem('gameSave');
    location.reload();
  }
};

// ---- –î–æ—Ö–æ–¥ –∏–≥—Ä–æ–∫–∞ ----
setInterval(()=>{
  let income=0, availableWorkers=population;
  shops.forEach(s=>{ if(availableWorkers>=s.workers){ income+=SHOP_INCOME; availableWorkers-=s.workers; } });
  factories.forEach(f=>{ if(availableWorkers>=f.workers){ income+=FACTORY_INCOME; availableWorkers-=f.workers; } });
  updateCoins(income);
  updateStatus();
},1000);

// ---- –°—Ç–∞—Ç—É—Å —Ä–∞–±–æ—á–∏—Ö ----
function updateStatus(){
  let neededWorkers=0;
  shops.forEach(s=>neededWorkers+=s.workers);
  factories.forEach(f=>neededWorkers+=f.workers);
  const freeWorkers=population-neededWorkers;
  if(freeWorkers<0){ statusDisplay.textContent=`üíº –ë–µ–∑—Ä–∞–±–æ—Ç–∏—Ü–∞: 0, –ù—É–∂–Ω—ã —Ä–∞–±–æ—á–∏–µ –¥–ª—è –≤—Å–µ—Ö –∑–¥–∞–Ω–∏–π!`; }
  else{ statusDisplay.textContent=`üíº –†–∞–±–æ—á–∏—Ö: ${population}, —Å–≤–æ–±–æ–¥–Ω—ã—Ö: ${freeWorkers}`; }
}

// ---- –ü–æ–≤–µ–¥–µ–Ω–∏–µ –±–æ—Ç–æ–≤: —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –¥–æ–º–æ–≤ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫ ----
function botBuildCycle(){
  bots.forEach((bot, idx)=>{
    if(!bot.polygon) return;
    const bounds = bot.polygon.getBounds();
    // —Å–ª—É—á–∞–π–Ω–æ–µ –º–µ—Å—Ç–æ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª–∏–≥–æ–Ω–∞
    const lat = bounds.getSouthWest().lat + Math.random()*(bounds.getNorthEast().lat-bounds.getSouthWest().lat);
    const lng = bounds.getSouthWest().lng + Math.random()*(bounds.getNorthEast().lng-bounds.getSouthWest().lng);
    const latlng = {lat, lng};
    // –µ—Å–ª–∏ –º–µ—Å—Ç–æ –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –±–æ—Ç–∞–º–∏ –∏ —É –±–æ—Ç–∞ –µ—Å—Ç—å –¥–µ–Ω—å–≥–∏
    if(bot.coins>=HOUSE_COST && !intersectsOtherBots(latlng, idx)){
      // 70% —à–∞–Ω—Å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–æ–º, 20% ‚Äî –º–∞–≥–∞–∑–∏–Ω (–µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç), 10% ‚Äî —Ñ–∞–±—Ä–∏–∫—É (–µ—Å–ª–∏ –º–Ω–æ–≥–æ –º–æ–Ω–µ—Ç)
      const r=Math.random();
      if(r<0.7){
        const m = L.marker([lat,lng],{icon:L.divIcon({className:'house',html:'üè†',iconSize:[24,24]})}).addTo(map);
        bot.houses.push(m);
        bot.markers.houses.push(m);
        bot.coins -= HOUSE_COST;
        bot.population += Math.floor(Math.random()*4)+3;
      } else if(r<0.9 && bot.coins>=SHOP_COST){
        const m = L.marker([lat,lng],{icon:L.divIcon({className:'shop',html:'üè¨',iconSize:[24,24]})}).addTo(map);
        bot.shops.push({marker:m, workers:SHOP_WORKERS});
        bot.markers.shops.push(m);
        bot.coins -= SHOP_COST;
      } else if(bot.coins>=FACTORY_COST && r>=0.9){
        const m = L.marker([lat,lng],{icon:L.divIcon({className:'factory',html:'üè≠',iconSize:[24,24]})}).addTo(map);
        bot.factories.push({marker:m, workers:FACTORY_WORKERS});
        bot.markers.factories.push(m);
        bot.coins -= FACTORY_COST;
      }
    }
  });
}

// ---- –ë–æ—Ç—ã —Ä–∞—Å—à–∏—Ä—è—é—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é —á–µ—Ä–µ–∑ Convex Hull –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫ ----
function botExpandCycle(){
  bots.forEach((bot,idx)=>{
    if(!bot.polygon) return;
    if(bot.coins<50) return;
    // –±–µ—Ä—ë–º —Ç–µ–∫—É—â–∏–µ —Ç–æ—á–∫–∏ –ø–æ–ª–∏–≥–æ–Ω–∞
    const latlngs = bot.polygon.getLatLngs()[0].map(p=>[p.lat,p.lng]);
    const base = latlngs[Math.floor(Math.random()*latlngs.length)];
    const dx = (Math.random()*150+50)*(Math.random()<0.5?-1:1);
    const dy = (Math.random()*150+50)*(Math.random()<0.5?-1:1);
    // –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –º–µ—Ç—Ä–æ–≤ –≤ –≥—Ä–∞–¥—É—Å—ã (–Ω–µ —Ç–æ—á–Ω–∞—è, –Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è)
    const newPoint = [base[0]+dy*0.00001, base[1]+dx*0.00001];
    latlngs.push(newPoint);
    const hull = convexHull(latlngs);
    bot.polygon.setLatLngs(hull.map(p=>({lat:p[0],lng:p[1]})));
    // –ø–µ—Ä–µ–º–µ—â–∞–µ–º –ª–µ–π–±–ª
    if(bot.label){ bot.label.setLatLng(bot.polygon.getBounds().getCenter()); }
    bot.coins -= 50;
  });
}

// ---- –ë–æ—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –¥–æ—Ö–æ–¥ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É ----
function botIncomeCycle(){
  bots.forEach(bot=>{
    if(!bot.polygon) return;
    let income=0, availableWorkers=bot.population;
    bot.shops.forEach(s=>{ if(availableWorkers>=s.workers){ income+=SHOP_INCOME; availableWorkers-=s.workers; } });
    bot.factories.forEach(f=>{ if(availableWorkers>=f.workers){ income+=FACTORY_INCOME; availableWorkers-=f.workers; } });
    bot.coins += income;
  });
}

// ---- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ –±–æ—Ç–æ–≤: —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤ ----
function restoreBotFromData(bData, botObj){
  botObj.coins = bData.coins ?? 5000;
  botObj.population = bData.population ?? 50;
  botObj.color = bData.color ?? botObj.color;

  // remove existing markers/polygon if any
  if(botObj.polygon){ map.removeLayer(botObj.polygon); botObj.polygon=null; }
  botObj.markers.houses.forEach(m=>map.removeLayer(m)); botObj.markers.houses=[];
  botObj.markers.shops.forEach(m=>map.removeLayer(m)); botObj.markers.shops=[];
  botObj.markers.factories.forEach(m=>map.removeLayer(m)); botObj.markers.factories=[];

  if(bData.polygon){
    botObj.polygon = L.polygon(bData.polygon,{color:botObj.color, weight:2, opacity:0.9}).addTo(map);
    botObj.label = L.marker(botObj.polygon.getBounds().getCenter(), { interactive:false, icon:L.divIcon({className:'botLabel', html:botObj.name, iconSize:[60,20]}) }).addTo(map);
  } else {
    // –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª–∏–≥–æ–Ω–∞ ‚Äî —Å–æ–∑–¥–∞—ë–º —Ä–∞–Ω–¥–æ–º–Ω–æ –Ω–µ–±–æ–ª—å—à–æ–π
    initBotsRandomly();
  }
  // –∑–¥–∞–Ω–∏—è
  botObj.houses = []; botObj.shops = []; botObj.factories = [];
  (bData.houses||[]).forEach(h=>{
    const m = L.marker(h,{icon:L.divIcon({className:'house',html:'üè†',iconSize:[24,24]})}).addTo(map);
    botObj.houses.push(m); botObj.markers.houses.push(m);
  });
  (bData.shops||[]).forEach(s=>{
    const latlng = s.latlng || s;
    const m = L.marker(latlng,{icon:L.divIcon({className:'shop',html:'üè¨',iconSize:[24,24]})}).addTo(map);
    botObj.shops.push({marker:m, workers: s.workers ?? SHOP_WORKERS}); botObj.markers.shops.push(m);
  });
  (bData.factories||[]).forEach(f=>{
    const latlng = f.latlng || f;
    const m = L.marker(latlng,{icon:L.divIcon({className:'factory',html:'üè≠',iconSize:[24,24]})}).addTo(map);
    botObj.factories.push({marker:m, workers: f.workers ?? FACTORY_WORKERS}); botObj.markers.factories.push(m);
  });
}

// ---- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ----
window.addEventListener('load',()=>{
  const saved=localStorage.getItem('gameSave');
  if(saved){
    const data=JSON.parse(saved);
    coins=data.coins ?? coins; population=data.population ?? population;
    coinDisplay.textContent=coins; popDisplay.textContent=population;

    if(data.polygon){ polygon=L.polygon(data.polygon,{color:'blue'}).addTo(map); initHandles(); }
    data.houses?.forEach(h=>houses.push(L.marker(h,{icon:L.divIcon({className:'house',html:'üè†',iconSize:[24,24]})}).addTo(map)));
    data.shops?.forEach(s=>shops.push({marker:L.marker(s.latlng,{icon:L.divIcon({className:'shop',html:'üè¨',iconSize:[24,24]})}).addTo(map), workers:s.workers}));
    data.factories?.forEach(f=>factories.push({marker:L.marker(f.latlng,{icon:L.divIcon({className:'factory',html:'üè≠',iconSize:[24,24]})}).addTo(map), workers:f.workers}));

    // restore bots if present
    if(data.bots && Array.isArray(data.bots) && data.bots.length===bots.length){
      data.bots.forEach((bData, i)=> restoreBotFromData(bData, bots[i]));
    } else {
      // –∏–Ω–∞—á–µ —Ä–∞–Ω–¥–æ–º–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      initBotsRandomly();
    }
    updateStatus();
  } else {
    // –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–æ–≤ —Ä–∞–Ω–¥–æ–º–Ω–æ
    initBotsRandomly();
  }
});

// ---- –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ü–∏–∫–ª–æ–≤ –±–æ—Ç–æ–≤ ----
setInterval(botBuildCycle, 2000);
setInterval(botExpandCycle, 5000);
setInterval(botIncomeCycle, 1000);

</script>
</body>
</html>
